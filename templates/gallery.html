<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>纹饰卷轴 · 交互版</title>
  <style>
    :root {
      --bg: #1a1a1a;
      --paper: #f3e5c9;
      --ink: #3e2723;
      --accent: #b71c1c;
      --shadow: rgba(0,0,0,0.35);
    }
    * { box-sizing: border-box; }
    body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: var(--ink); font-family: "KaiTi","楷体","STKaiti",serif; overflow: hidden; user-select: none; }

    .scroll-container {
      position: relative; height: 100vh; width: 100vw;
      display: flex; align-items: center; justify-content: center;
      overflow: hidden;
    }
    .roller {
      width: 60px; height: 90vh;
      background: linear-gradient(90deg, #2d1e18, #5d4037, #2d1e18);
      border-radius: 12px;
      box-shadow: 10px 0 30px rgba(0,0,0,0.8);
      z-index: 50; position: relative; cursor: pointer;
      transition: transform 0.1s;
      display: flex; align-items: center; justify-content: center;
    }
    .roller:active { transform: scale(0.98); }
    .roller::before, .roller::after {
      content: ''; position: absolute; width: 110%; left: -5%; height: 40px;
      background: radial-gradient(circle at 30% 30%, #8d6e63, #5d4037);
      border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      border-top: 2px solid #a1887f;
    }
    .roller::before { top: -40px; }
    .roller::after { bottom: -40px; }

    .scroll-paper {
      height: 92vh; width: 0;
      background-color: var(--paper);
      background-image: url('https://www.transparenttextures.com/patterns/rice-paper.png'),
        linear-gradient(to right, rgba(0,0,0,0.05) 1px, transparent 1px);
      background-size: auto, 100px 100%;
      box-shadow: inset 0 0 80px rgba(62,39,35,0.3);
      overflow: hidden;
      transition: width 1.8s cubic-bezier(0.2, 1, 0.3, 1);
      position: relative; display: flex; align-items: center;
    }

    .timeline-content {
      display: flex; height: 100%;
      padding: 0 80px;
      opacity: 0; transition: opacity 1.2s ease 0.9s;
      min-width: max-content;
    }

    .dynasty-section {
      display: flex;
      flex-direction: row;
      height: 100%;
      margin-right: 120px;
      border-right: 1px solid rgba(141, 110, 99, 0.3);
      padding-right: 60px;
    }

    .dynasty-narrative {
      height: 80%; margin-top: 5%;
      writing-mode: vertical-rl;
      display: flex; flex-direction: column;
      align-items: center; gap: 20px;
      margin-right: 40px; margin-left: 20px;
      text-align: justify;
    }
    .dynasty-title {
      font-size: 3.2rem; font-weight: bold; color: var(--ink);
      font-family: "LiSu","隶书",serif;
      letter-spacing: 0.4rem;
      border: 2px solid var(--ink); padding: 12px 10px;
      border-radius: 4px;
      background-color: rgba(255,255,255,0.4);
      box-shadow: 3px 3px 0 rgba(62,39,35,0.2);
    }
    .dynasty-intro {
      font-size: 1.4rem; line-height: 2; color: #5d4037;
      height: 100%; letter-spacing: 0.2rem;
      border-left: 1px dashed #a1887f; padding-left: 15px;
      font-family: "LiSu","隶书",serif;
    }
    .highlight { color: #b71c1c; font-weight: bold; }

    .dynasty-gallery {
      display: flex; flex-direction: column; gap: 18px;
      width: 520px;
      height: 100%;
      overflow-y: auto;
      padding: 30px 0;
      scrollbar-width: thin;
    }
    .dynasty-gallery::-webkit-scrollbar { width: 6px; }
    .dynasty-gallery::-webkit-scrollbar-thumb { background: #b0a08f; border-radius: 3px; }

    .pattern-card {
      display: flex; flex-direction: column; align-items: center;
      background: rgba(255,255,255,0.6);
      padding: 12px;
      border-radius: 6px;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.12);
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
      position: relative;
    }
    .pattern-card:hover { transform: scale(1.03); box-shadow: 5px 5px 14px rgba(0,0,0,0.18); }
    .pattern-img {
      width: 100%; height: 220px; object-fit: contain;
      filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.25));
    }
    .pattern-info { margin-top: 8px; text-align: center; }
    .pattern-name { font-size: 1rem; color: var(--ink); font-weight: bold; margin-bottom: 4px; }
    .reign-tag {
      font-size: 0.78rem; color: #fff; background-color: #8d6e63;
      padding: 2px 6px; border-radius: 3px; display: inline-block;
    }

    .ribbon {
      position: absolute; width: 70px; height: 360px;
      background: var(--accent); left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 5px 5px 15px rgba(0,0,0,0.6);
      z-index: 60; cursor: pointer; transition: all 0.8s;
      writing-mode: vertical-rl;
      display: flex; align-items: center; justify-content: center;
      color: #ffd700; font-size: 2rem; font-weight: bold;
      border: 3px solid #ffd700; outline: 2px solid var(--accent);
      letter-spacing: 15px; border-radius: 4px;
      font-family: "LiSu","隶书",serif;
    }
    .ribbon:hover { transform: translate(-50%, -50%) scale(1.05); }
    .hint-text {
      position: absolute; bottom: 5%; left: 50%; transform: translateX(-50%);
      color: rgba(255,255,255,0.6); font-size: 0.95rem; letter-spacing: 2px;
      animation: pulse 2s infinite; pointer-events: none; opacity: 0; transition: opacity 1s;
    }
    @keyframes pulse { 0%,100% { opacity: 0.3; } 50% { opacity: 0.9; } }

    .is-open .scroll-paper { width: 90vw; }
    .is-open .ribbon { opacity: 0; pointer-events: none; transform: translate(-50%, -150%); }
    .is-open .timeline-content { opacity: 1; }
    .is-open .hint-text { opacity: 1; }

    /* 详情弹窗 */
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.65);
      display: none; align-items: center; justify-content: center; z-index: 2000;
      padding: 20px;
    }
    .modal.show { display: flex; }
    .modal-box {
      background: #fdfbf6;
      width: min(1100px, 95vw);
      height: min(90vh, 760px);
      border-radius: 10px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.35);
      display: grid;
      grid-template-columns: 60% 40%;
      overflow: hidden;
      position: relative;
    }
    .modal-img-wrap {
      background: #ffffff;
      position: relative;
      overflow: auto;
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
    }
    .modal-img-container {
      min-width: 100%;
      min-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-img {
      max-width: 80%;
      max-height: 80%;
      width: auto;
      height: auto;
      transition: transform 0.2s ease;
      transform-origin: center center;
    }
    .zoom-panel {
      position: absolute;
      right: 12px; bottom: 12px;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(0,0,0,0.2);
      border-radius: 6px;
      padding: 6px 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #000;
      font-weight: bold;
    }
    .zoom-btn {
      width: 28px; height: 28px;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.5);
      background: rgba(0,0,0,0.25);
      color: #fff; cursor: pointer;
    }
    .modal-info {
      padding: 18px 18px 12px 18px;
      overflow-y: auto;
    }
    .info-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 6px; }
    .info-sub { color: #6d4c41; margin-bottom: 12px; }
    .info-table { width: 100%; border-collapse: collapse; font-size: 0.92rem; }
    .info-table td { padding: 6px 4px; vertical-align: top; border-bottom: 1px solid #eee; }
    .info-table td:first-child { width: 34%; color: #795548; font-weight: bold; }
    .tag-item {
      display: inline-block;
      background-color: #f5f5f5;
      padding: 3px 8px;
      margin: 2px 4px 2px 0;
      border-radius: 4px;
      font-size: 0.9em;
    }
    
    /* 处理窗口样式 */
    .process-modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.75);
      display: none; align-items: center; justify-content: center; z-index: 3000;
    }
    .process-modal.show { display: flex; }
    .process-box {
      background: #fdfbf6; width: min(700px, 90vw);
      border-radius: 12px; box-shadow: 0 16px 48px rgba(0,0,0,0.4);
      padding: 28px; position: relative;
    }
    .process-title {
      font-size: 1.4rem; font-weight: bold; margin-bottom: 20px;
      color: var(--ink);
    }
    .process-upload {
      margin-bottom: 20px;
    }
    .process-upload input[type="file"] {
      display: none;
    }
    .process-upload-label {
      display: inline-block;
      padding: 10px 20px;
      background: #8d6e63;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
    }
    .process-upload-label:hover {
      background: #a1887f;
    }
    .process-preview {
      margin-top: 12px;
      max-width: 100%;
      max-height: 200px;
      border-radius: 6px;
      display: none;
    }
    .process-preview.show {
      display: block;
    }
    .process-step {
      font-size: 1rem; margin-bottom: 12px; color: #5d4037;
    }
    .process-progress {
      width: 100%; height: 24px; background: #e0e0e0;
      border-radius: 12px; overflow: hidden; margin: 16px 0;
    }
    .process-progress-bar {
      height: 100%; background: linear-gradient(90deg, #8d6e63, #a1887f);
      transition: width 0.3s ease; width: 0%;
    }
    .process-message {
      font-size: 0.9rem; color: #666; margin-top: 8px;
      min-height: 20px;
    }
    .process-actions {
      display: flex; gap: 12px; margin-top: 20px; justify-content: flex-end;
    }
    .process-btn {
      padding: 8px 20px; border: none; border-radius: 6px;
      cursor: pointer; font-size: 0.95rem;
    }
    .process-btn-primary {
      background: #8d6e63; color: #fff;
    }
    .process-btn-secondary {
      background: #e0e0e0; color: #333;
    }
    .process-close-btn {
      position: absolute; top: 16px; right: 16px;
      width: 32px; height: 32px; border: none; border-radius: 50%;
      background: #ef5350; color: #fff; font-size: 20px; cursor: pointer;
    }
    .modal-close {
      position: absolute; top: 12px; right: 12px;
      width: 34px; height: 34px; border: none; border-radius: 50%;
      background: #ef5350; color: #fff; font-size: 18px; cursor: pointer;
      box-shadow: 0 6px 14px rgba(0,0,0,0.2);
    }
    
    /* 转换过程动画窗口 */
    .animation-modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.85);
      display: none; align-items: center; justify-content: center; z-index: 4000;
    }
    .animation-modal.show { display: flex; }
    .animation-box {
      background: #fdfbf6; width: min(1000px, 95vw);
      height: min(85vh, 750px); border-radius: 12px;
      box-shadow: 0 16px 48px rgba(0,0,0,0.5);
      padding: 28px; position: relative; display: flex; flex-direction: column;
    }
    .animation-title {
      font-size: 1.6rem; font-weight: bold; margin-bottom: 24px;
      color: var(--ink); text-align: center;
      font-family: "LiSu","隶书",serif;
    }
    .animation-container {
      flex: 1; display: flex; flex-direction: column; gap: 20px;
    }
    .animation-stage {
      flex: 1; display: flex; flex-direction: column; align-items: center;
      justify-content: center; position: relative;
      background: #fff; border-radius: 8px; padding: 20px;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
    }
    .stage-image-container {
      position: relative; width: 100%; max-width: 700px;
      height: 500px; display: flex; align-items: center; justify-content: center;
      background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
      border-radius: 8px; overflow: hidden;
    }
    .stage-image {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      max-width: 90%; max-height: 90%;
      width: auto; height: auto;
      opacity: 0; transition: opacity 1.2s ease-in-out, transform 1.2s ease-in-out;
      border-radius: 4px; box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    .stage-image.active {
      opacity: 1; transform: translate(-50%, -50%) scale(1);
      z-index: 10;
    }
    .stage-image.fade-out {
      opacity: 0; transform: translate(-50%, -50%) scale(0.95);
    }
    .stage-label {
      position: absolute; top: 20px; left: 50%;
      transform: translateX(-50%);
      font-size: 1.4rem; font-weight: bold;
      color: #5d4037; font-family: "LiSu","隶书",serif;
      background: rgba(255,255,255,0.9);
      padding: 8px 24px; border-radius: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 20;
      transition: all 0.3s ease;
    }
    .stage-progress {
      position: absolute; bottom: 20px; left: 50%;
      transform: translateX(-50%);
      display: flex; gap: 8px; z-index: 20;
    }
    .progress-dot {
      width: 12px; height: 12px; border-radius: 50%;
      background: rgba(141, 110, 99, 0.3);
      transition: all 0.3s ease;
    }
    .progress-dot.active {
      background: #8d6e63; transform: scale(1.3);
    }
    .animation-controls {
      display: flex; justify-content: center; align-items: center; gap: 16px;
      padding-top: 20px; border-top: 1px solid #e0e0e0;
    }
    .anim-btn {
      padding: 10px 24px; border: none; border-radius: 6px;
      cursor: pointer; font-size: 1rem; background: #e0e0e0;
      color: #333; transition: all 0.2s;
    }
    .anim-btn:hover { background: #d0d0d0; }
    .anim-btn-primary {
      background: #8d6e63; color: #fff;
    }
    .anim-btn-primary:hover { background: #a1887f; }
    .anim-btn:disabled {
      opacity: 0.5; cursor: not-allowed;
    }
    .animation-close-btn {
      position: absolute; top: 16px; right: 16px;
      width: 32px; height: 32px; border: none; border-radius: 50%;
      background: #ef5350; color: #fff; font-size: 20px; cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="scroll-container" id="scrollContainer">
    <div class="roller" id="leftRoller" title="向左卷动"></div>

    <div class="scroll-paper" id="scrollPaper">
      <div class="timeline-content">

        <div style="writing-mode: vertical-rl; height: 70%; margin: auto 50px; font-size: 1.5rem; line-height: 2.4; color: #5d4037;">
          <div style="font-weight: bold; font-size: 2.5rem; margin-bottom: 20px;">纹饰千载</div>
          <div>从泥土的初醒，到窑火的辉煌。</div>
          <div>请向右卷动，开启这段中华美学之旅。</div>
          <div style="margin-top: 30px;">
            <button id="processBtn" style="background: #8d6e63; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 1rem;" onclick="openProcessModal()">进入纹饰提取工坊</button>
          </div>
        </div>

        {% for block in timeline %}
        <div class="dynasty-section">
          <div class="dynasty-narrative">
            <div class="dynasty-title">{{ block.dynasty or '未分组' }}</div>
            {% if block.story %}
            <div class="dynasty-intro">{{ block.story|safe }}</div>
            {% endif %}
          </div>

          <div class="dynasty-gallery">
            {% for item in block.items_list %}
            <div class="pattern-card"
                 data-tag="{{ item.tag }}"
                 data-name="{{ item.name }}"
                 data-dynasty="{{ item.dynasty }}"
                 data-image="{{ item.image }}"
                 data-details='{{ item.details | tojson }}'
            >
              {% if item.image %}
                <img class="pattern-img" src="{{ item.image }}" loading="lazy">
              {% else %}
                <div class="pattern-img" style="display:flex;align-items:center;justify-content:center;color:#999;">无图片</div>
              {% endif %}
              <div class="pattern-info">
                <div class="pattern-name">{{ item.name or item.tag }}</div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endfor %}

        <div style="writing-mode: vertical-rl; height: 70%; margin: auto 50px; font-size: 1.2rem; line-height: 2; color: #8d6e63; border-left: 1px solid #8d6e63; padding-left:20px;">
          <div>观纹饰，如读史。</div>
          <div>方寸之间，气象万千。</div>
        </div>

      </div>
    </div>

    <div class="ribbon" id="ribbon">启卷</div>
    <div class="hint-text">按住画轴左右卷动</div>
    <div class="roller" id="rightRoller" title="向右卷动"></div>
  </div>

  <!-- 详情弹窗 -->
  <div class="modal" id="modal">
    <div class="modal-box">
      <div class="modal-img-wrap" id="modalImgWrap">
        <div class="modal-img-container">
          <img id="modalImg" class="modal-img" src="" alt="">
        </div>
        <div class="zoom-panel">
          <button class="zoom-btn" data-step="-0.15">-</button>
          <span id="zoomLevel">100%</span>
          <button class="zoom-btn" data-step="0.15">+</button>
        </div>
      </div>
      <div class="modal-info">
        <div class="info-title" id="infoTitle"></div>
        <div class="info-sub" id="infoSub"></div>
        <table class="info-table" id="infoTable"></table>
      </div>
      <button class="modal-close" id="modalClose">×</button>
    </div>
  </div>

  <!-- 处理窗口 -->
  <div class="process-modal" id="processModal">
    <div class="process-box">
      <button class="process-close-btn" onclick="closeProcessModal()">×</button>
      <div class="process-title">核心纹饰提取工坊</div>
      
      <div class="process-upload">
        <label for="imageUpload" class="process-upload-label">选择图片</label>
        <input type="file" id="imageUpload" accept="image/*" onchange="handleFileSelect(event)">
        <img id="previewImg" class="process-preview" alt="预览">
      </div>
      
      <div class="process-step" id="processStep">请选择一张图片开始处理</div>
      <div class="process-progress">
        <div class="process-progress-bar" id="processProgressBar"></div>
      </div>
      <div class="process-message" id="processMessage"></div>
      <div class="process-actions">
        <button class="process-btn process-btn-primary" id="startProcessBtn" onclick="startProcessing()" disabled>开始处理</button>
        <button class="process-btn process-btn-secondary" id="viewResultBtn" onclick="viewResult()" style="display:none;">查看结果</button>
        <button class="process-btn process-btn-secondary" id="viewAnimationBtn" onclick="showAnimation()" style="display:none;">观看转换过程</button>
      </div>
    </div>
  </div>

  <!-- 转换过程动画窗口 -->
  <div class="animation-modal" id="animationModal">
    <div class="animation-box">
      <button class="animation-close-btn" onclick="closeAnimation()">×</button>
      <div class="animation-title">纹饰提取转换过程</div>
      <div class="animation-container">
        <div class="animation-stage" id="animationStage">
          <div class="stage-label" id="stageLabel">原始照片</div>
          <div class="stage-image-container">
            <img id="animOriginal" class="stage-image active" src="" alt="原始照片">
            <img id="animSaliency" class="stage-image" src="" alt="显著性图">
            <img id="animExtracted" class="stage-image" src="" alt="提取的纹饰">
            <img id="animFinal" class="stage-image" src="" alt="最终结果">
          </div>
          <div class="stage-progress" id="stageProgress">
            <div class="progress-dot active" data-step="0"></div>
            <div class="progress-dot" data-step="1"></div>
            <div class="progress-dot" data-step="2"></div>
            <div class="progress-dot" data-step="3"></div>
          </div>
        </div>
        <div class="animation-controls">
          <button class="anim-btn" id="prevBtn" onclick="prevStep()">← 上一步</button>
          <button class="anim-btn anim-btn-primary" id="playBtn" onclick="toggleAnimation()">播放动画</button>
          <button class="anim-btn" id="nextBtn" onclick="nextStep()">下一步 →</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 卷轴交互
    const container = document.getElementById('scrollContainer');
    const paper = document.getElementById('scrollPaper');
    const ribbon = document.getElementById('ribbon');
    let isOpen = false, interval;
    const speed = 22;

    ribbon.addEventListener('click', () => {
      container.classList.add('is-open');
      isOpen = true;
    });
    const startScroll = (d) => {
      if(!isOpen) return;
      clearInterval(interval);
      interval = setInterval(() => { paper.scrollLeft += d; }, 15);
    };
    const stopScroll = () => clearInterval(interval);
    const rollers = [document.getElementById('leftRoller'), document.getElementById('rightRoller')];
    rollers[0].addEventListener('mousedown', () => startScroll(-speed));
    rollers[0].addEventListener('touchstart', (e) => { e.preventDefault(); startScroll(-speed); });
    rollers[1].addEventListener('mousedown', () => startScroll(speed));
    rollers[1].addEventListener('touchstart', (e) => { e.preventDefault(); startScroll(speed); });
    ['mouseup', 'mouseleave', 'touchend'].forEach(evt => {
      rollers.forEach(r => r.addEventListener(evt, stopScroll));
    });
    // 滚轮仅控制各模块的上下滚动，不控制卷轴左右滚动
    document.querySelectorAll('.dynasty-gallery').forEach(gallery => {
      gallery.addEventListener('wheel', (e) => {
        // 允许模块内部上下滚动
        e.stopPropagation();
      });
    });

    // 详情弹窗
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modalImg');
    const modalImgContainer = document.querySelector('.modal-img-container');
    const infoTitle = document.getElementById('infoTitle');
    const infoSub = document.getElementById('infoSub');
    const infoTable = document.getElementById('infoTable');
    const zoomLevel = document.getElementById('zoomLevel');
    const zoomButtons = document.querySelectorAll('.zoom-btn');
    let scale = 1.0;

    function setZoom(val) {
      scale = Math.min(3.0, Math.max(0.3, val));
      modalImg.style.transform = `scale(${scale})`;
      zoomLevel.textContent = Math.round(scale * 100) + '%';
    }

    document.querySelectorAll('.pattern-card').forEach(card => {
      card.addEventListener('click', () => {
        const name = card.dataset.name || card.dataset.tag;
        const dynasty = card.dataset.dynasty || '';
        const img = card.dataset.image || '';
        const details = JSON.parse(card.dataset.details || '[]');

        infoTitle.textContent = name;
        infoSub.textContent = dynasty ? `朝代/时期：${dynasty}` : '';
        // 过滤掉tag列和空值
        const filteredDetails = details.filter(d => {
          const label = (d.label || '').trim();
          const value = (d.value || '').trim();
          return label && label.toLowerCase() !== 'tag' && value;
        });
        infoTable.innerHTML = filteredDetails.map(d => {
          const label = d.label || '';
          let value = (d.value || '').replace(/\\n/g, '<br>');
          
          // 如果是标签字段，为每个标签添加背景
          if (label.includes('标签') || label.toLowerCase().includes('tag')) {
            // 将标签按空格、逗号、顿号等分割，为每个标签添加背景
            const tags = value.split(/[，,、\s]+/).filter(t => t.trim());
            value = tags.map(tag => `<span class="tag-item">${tag.trim()}</span>`).join('');
          }
          
          return `
            <tr>
              <td>${label}</td>
              <td>${value}</td>
            </tr>
          `;
        }).join('');

        if (img) {
          modalImg.src = img;
          modalImg.style.display = 'block';
        } else {
          modalImg.src = '';
          modalImg.style.display = 'none';
        }

        setZoom(1.0);
        modal.classList.add('show');
      });
    });

    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.classList.remove('show');
    });
    document.getElementById('modalClose').addEventListener('click', () => modal.classList.remove('show'));

    zoomButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const step = parseFloat(btn.dataset.step || '0');
        setZoom(scale + step);
      });
    });

    // 滚轮仅控制缩放，不控制滚动
    modalImg.addEventListener('wheel', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const delta = e.deltaY > 0 ? -0.1 : 0.1;
      setZoom(scale + delta);
    }, { passive: false });
    
    // 阻止滚轮事件冒泡到scrollbar
    modalImgWrap.addEventListener('wheel', (e) => {
      if (e.target === modalImg || modalImgContainer.contains(e.target)) {
        e.stopPropagation();
      }
    }, { passive: false });

    // 处理窗口功能
    const processModal = document.getElementById('processModal');
    const processStep = document.getElementById('processStep');
    const processProgressBar = document.getElementById('processProgressBar');
    const processMessage = document.getElementById('processMessage');
    const startProcessBtn = document.getElementById('startProcessBtn');
    const viewResultBtn = document.getElementById('viewResultBtn');
    const previewImg = document.getElementById('previewImg');
    let statusInterval = null;
    let selectedFile = null;

    function openProcessModal() {
      processModal.classList.add('show');
      resetProcessModal();
    }

    function closeProcessModal() {
      processModal.classList.remove('show');
      if (statusInterval) {
        clearInterval(statusInterval);
        statusInterval = null;
      }
      resetProcessModal();
    }

    function resetProcessModal() {
      processStep.textContent = '请选择一张图片开始处理';
      processProgressBar.style.width = '0%';
      processMessage.textContent = '';
      startProcessBtn.disabled = true;
      startProcessBtn.textContent = '开始处理';
      viewResultBtn.style.display = 'none';
      document.getElementById('viewAnimationBtn').style.display = 'none';
      previewImg.classList.remove('show');
      selectedFile = null;
      window.processSteps = null;
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      selectedFile = file;
      startProcessBtn.disabled = false;
      processStep.textContent = '图片已选择，点击开始处理';

      // 显示预览
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImg.src = e.target.result;
        previewImg.classList.add('show');
      };
      reader.readAsDataURL(file);
    }

    function startProcessing() {
      if (!selectedFile) {
        alert('请先选择图片');
        return;
      }

      startProcessBtn.disabled = true;
      startProcessBtn.textContent = '处理中...';
      
      const formData = new FormData();
      formData.append('file', selectedFile);
      formData.append('model_path', './saved_models/u2net/u2net.pth');
      
      fetch('/api/process/upload', {
        method: 'POST',
        body: formData
      }).then(r => r.json())
        .then(data => {
          if (data.error) {
            processMessage.textContent = '错误: ' + data.error;
            startProcessBtn.disabled = false;
            startProcessBtn.textContent = '开始处理';
          } else {
            checkStatus();
          }
        })
        .catch(err => {
          processMessage.textContent = '启动失败: ' + err;
          startProcessBtn.disabled = false;
          startProcessBtn.textContent = '开始处理';
        });
    }

    function checkStatus() {
      if (statusInterval) return;
      statusInterval = setInterval(() => {
        fetch('/api/process/status')
          .then(r => r.json())
          .then(data => {
            processStep.textContent = data.step || '准备就绪';
            processProgressBar.style.width = (data.progress || 0) + '%';
            processMessage.textContent = data.message || '';
            
            if (data.error) {
              processMessage.textContent = '错误: ' + data.error;
              startProcessBtn.disabled = false;
              startProcessBtn.textContent = '重新处理';
              clearInterval(statusInterval);
              statusInterval = null;
            } else if (!data.running && data.progress === 100) {
              startProcessBtn.disabled = false;
              startProcessBtn.textContent = '重新处理';
              if (data.result_image) {
                viewResultBtn.style.display = 'inline-block';
                viewResultBtn.onclick = () => {
                  window.open(data.result_image, '_blank');
                };
                // 如果有转换过程步骤，显示动画按钮
                if (data.process_steps && data.process_steps.original) {
                  document.getElementById('viewAnimationBtn').style.display = 'inline-block';
                  window.processSteps = data.process_steps;
                }
              }
              clearInterval(statusInterval);
              statusInterval = null;
            } else if (!data.running && data.progress === 0) {
              startProcessBtn.disabled = false;
              startProcessBtn.textContent = '开始处理';
            }
          })
          .catch(err => {
            console.error('状态检查失败:', err);
          });
      }, 500);
    }

    function viewResult() {
      // 由checkStatus中动态设置
    }

    // 转换过程动画功能
    const animationModal = document.getElementById('animationModal');
    let currentStep = 0;
    let animationInterval = null;
    const steps = ['original', 'saliency', 'extracted', 'final'];
    const stepLabels = {
      'original': '原始照片',
      'saliency': '显著性检测',
      'extracted': '纹饰提取',
      'final': '最终结果'
    };
    const stepImages = {
      'original': 'animOriginal',
      'saliency': 'animSaliency',
      'extracted': 'animExtracted',
      'final': 'animFinal'
    };

    function showAnimation() {
      if (!window.processSteps) {
        alert('转换过程数据不可用');
        return;
      }
      
      // 设置图片
      document.getElementById('animOriginal').src = window.processSteps.original || '';
      document.getElementById('animSaliency').src = window.processSteps.saliency || '';
      document.getElementById('animExtracted').src = window.processSteps.extracted || '';
      document.getElementById('animFinal').src = window.processSteps.final || '';
      
      // 重置到第一步
      currentStep = 0;
      updateAnimationDisplay();
      animationModal.classList.add('show');
    }

    function closeAnimation() {
      animationModal.classList.remove('show');
      stopAnimation();
    }

    function updateAnimationDisplay() {
      // 更新图片显示（淡入淡出效果）
      steps.forEach((step, index) => {
        const imgElement = document.getElementById(stepImages[step]);
        if (imgElement) {
          if (index === currentStep) {
            // 先移除其他类，再添加active类
            imgElement.classList.remove('fade-out');
            setTimeout(() => {
              imgElement.classList.add('active');
            }, 50);
          } else {
            // 淡出当前图片
            imgElement.classList.remove('active');
            imgElement.classList.add('fade-out');
          }
        }
      });
      
      // 更新标签
      const labelElement = document.getElementById('stageLabel');
      if (labelElement) {
        labelElement.textContent = stepLabels[steps[currentStep]];
      }
      
      // 更新进度点
      document.querySelectorAll('.progress-dot').forEach((dot, index) => {
        if (index === currentStep) {
          dot.classList.add('active');
        } else {
          dot.classList.remove('active');
        }
      });
      
      // 更新按钮状态
      document.getElementById('prevBtn').disabled = currentStep === 0;
      document.getElementById('nextBtn').disabled = currentStep === steps.length - 1;
    }

    function prevStep() {
      if (currentStep > 0) {
        currentStep--;
        updateAnimationDisplay();
      }
    }

    function nextStep() {
      if (currentStep < steps.length - 1) {
        currentStep++;
        updateAnimationDisplay();
      }
    }

    function toggleAnimation() {
      const playBtn = document.getElementById('playBtn');
      if (animationInterval) {
        stopAnimation();
        playBtn.textContent = '播放动画';
      } else {
        startAnimation();
        playBtn.textContent = '暂停动画';
      }
    }

    function startAnimation() {
      stopAnimation();
      // 如果已经在最后一步，从头开始
      if (currentStep >= steps.length - 1) {
        currentStep = -1;
      }
      animationInterval = setInterval(() => {
        if (currentStep < steps.length - 1) {
          currentStep++;
          updateAnimationDisplay();
        } else {
          stopAnimation();
          document.getElementById('playBtn').textContent = '播放动画';
        }
      }, 2500); // 每2.5秒切换一步，给淡入淡出效果足够时间
    }

    function stopAnimation() {
      if (animationInterval) {
        clearInterval(animationInterval);
        animationInterval = null;
      }
    }

    // 点击背景关闭
    animationModal.addEventListener('click', (e) => {
      if (e.target === animationModal) {
        closeAnimation();
      }
    });
  </script>
</body>
</html>

